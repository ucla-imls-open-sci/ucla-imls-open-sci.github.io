---
import Layout from '../../layouts/Layout.astro';
import lessonsData from '../../data/lessons.yml';
import siteTextData from '../../data/sitetext.yml';
import { siteConfig } from '../../site_config';
import { slugify } from '../../utils/slugs';

export async function getStaticPaths() {
  const lessons = (lessonsData as any).lessons || [];
  return lessons.map((lesson: any) => ({
    params: { slug: slugify(lesson.name) },
    props: { lesson },
  }));
}

const { lesson } = Astro.props;
const t = (siteTextData as any)[siteConfig.locale];
const authorProfiles = t.authors.people || [];

// Helper to find author details
const getAuthorDetails = (name: string) => {
    return authorProfiles.find((p: any) => 
        p.name.trim() === name.trim() || 
        `${p.name} ${p.lastname}` === name.trim()
    );
};

// Carpentries Lifecycle Definitions
const statusDefinitions: Record<string, string> = {
    "pre-alpha": "The lesson is in early design and development. Content is likely incomplete and subject to significant changes.",
    "alpha": "A full draft exists and is being piloted by the original developers. Gaps or inconsistencies may still be present.",
    "beta": "The lesson is ready for community piloting! It has been tested by developers and is now seeking feedback from external instructors.",
    "stable": "Mature curriculum. Extensively tested and major changes are not anticipated without significant warning."
};

const currentStatus = lesson.status ? lesson.status.toLowerCase() : 'unknown';
const statusDesc = statusDefinitions[currentStatus] || "Current development stage of the lesson.";

// Status Color Helper
const getStatusColor = (status: string) => {
  const s = status?.toLowerCase() || '';
  if (s.includes('beta')) return 'badge-success'; 
  if (s.includes('alpha') && !s.includes('pre')) return 'badge-warning'; 
  return 'badge-secondary';
};
const statusColor = getStatusColor(lesson.status);
const isExternal = lesson.type === 'external';

// Citation Helper
const generateCitation = (l: any) => {
    const year = new Date().getFullYear(); // Or use a 'date' field if added later
    const authorList = l.authors ? l.authors.map((a: string) => {
        const parts = a.split(' ');
        const last = parts[parts.length - 1];
        const first = parts[0][0];
        return `${last}, ${first}.`;
    }).join(', ') : 'UCLA IMLS Open Science';
    
    const apa = `${authorList} (${year}). ${l.name}. UCLA IMLS Open Science. ${siteConfig.url}/lessons/${slugify(l.name)}`;
    
    const bibtexAuthor = l.authors ? l.authors.join(' and ') : 'UCLA IMLS Open Science';
    const bibtexId = slugify(l.name).replace(/-/g, '_');
    const bibtex = `@misc{${bibtexId}_${year},
  author = {${bibtexAuthor}},
  title = {${l.name}},
  year = {${year}},
  publisher = {UCLA IMLS Open Science},
  url = {${siteConfig.url}/lessons/${slugify(l.name)}}
}`;

    return { apa, bibtex };
};

const citation = generateCitation(lesson);
---

<Layout title={lesson.name} description={`A lesson on ${lesson.name} for librarians.`}>
  <!-- Hero Section -->
  <header class="masthead" style="background-image: url('/assets/img/background-image-blue.png'); background-size: cover; min-height: 450px; padding-top: 6rem; padding-bottom: 3rem;">
    <div class="container">
      <div class="row align-items-center justify-content-center text-center">
        <div class="col-lg-10">
          <h1 class="text-white font-weight-bold" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.6); font-size: clamp(2rem, 5vw, 3.5rem); line-height: 1.2;">{lesson.name}</h1>
          <hr class="divider my-4" style="border-color: #ffd100; border-width: 3px; max-width: 50px;" />
        </div>
        <div class="col-lg-8">
          <div class="text-white-75 font-weight-light mb-5" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">
            <span class="mr-3">Level: <strong>{lesson.educationalLevel}</strong></span>
            
            {lesson.library_carpentry_adopted && (
                <span class="badge badge-success text-uppercase ml-1" title="Adopted by Library Carpentry">
                    <i class="fas fa-check-circle mr-1"></i> Library Carpentry Adopted
                </span>
            )}
            
            {/* Tooltip Container */}
            <span class="position-relative d-inline-block" style="cursor: help;">
                Status: 
                <span class={`badge ${statusColor} text-uppercase ml-1`}>{lesson.status}</span>
                <div class="custom-tooltip shadow-lg">
                    <p class="mb-1"><strong>The Carpentries {lesson.status} Stage</strong></p>
                    <small>{statusDesc}</small>
                </div>
            </span>
            
            {lesson.status_note && (
                <div class="mt-2 small text-white-50">
                    <i class="fas fa-info-circle mr-1"></i> {lesson.status_note}
                </div>
            )}
          </div>
          
          {lesson.url && (
              <a class="btn btn-primary btn-xl js-scroll-trigger" href={lesson.url} target="_blank">
                  {isExternal ? 'Visit Resource' : 'Start Lesson'}
              </a>
          )}
        </div>
      </div>
    </div>
  </header>

  <!-- Lesson Details -->
  <section class="page-section" id="details">
    <div class="container">
      <div class="row">
        <!-- Main Content -->
        <div class="col-lg-8">
          <h3 class="mt-4">About this {isExternal ? 'Resource' : 'Lesson'}</h3>
          <p class="lead">
            {lesson.abstract}
          </p>
          
          {lesson.teaches && lesson.teaches.length > 0 && (
            <div class="mt-4">
                <h4>Learning Objectives</h4>
                <ul>
                    {lesson.teaches.map((item: string) => (
                        <li>{item}</li>
                    ))}
                </ul>
            </div>
          )}

          <div class="mt-5">
            <h4>Keywords</h4>
            <div class="d-flex flex-wrap">
                {lesson.keywords && lesson.keywords.map((keyword: string) => (
                    <span class="badge badge-secondary mr-2 mb-2 p-2" style="font-size: 0.9rem;">{keyword}</span>
                ))}
            </div>
          </div>

          <!-- Workshop History -->
          {lesson.pilots && lesson.pilots.length > 0 && (
            <div class="mt-5">
                <h4><i class="fas fa-history mr-2 text-muted"></i>Workshop History</h4>
                <div class="table-responsive">
                    <table class="table table-hover table-sm mt-3">
                        <thead class="thead-light">
                            <tr>
                                <th>Date</th>
                                <th>Location</th>
                                <th>Format</th>
                                <th>Instructor</th>
                            </tr>
                        </thead>
                        <tbody>
                            {lesson.pilots.map((pilot: any) => (
                                <tr>
                                    <td>{new Date(pilot.date).toLocaleDateString()}</td>
                                    <td>{pilot.location}</td>
                                    <td><span class="badge badge-light border">{pilot.type}</span></td>
                                    <td>{pilot.instructor}</td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            </div>
          )}

          <!-- Recognition & Impact -->
          {lesson.recognition && lesson.recognition.length > 0 && (
            <div class="mt-5">
                <h4><i class="fas fa-award mr-2 text-muted"></i>Recognition & Impact</h4>
                <div class="row">
                    {lesson.recognition.map((item: any) => (
                        <div class="col-md-6 mb-3">
                            <div class="card h-100 border-0 bg-light shadow-sm">
                                <div class="card-body">
                                    <h6 class="font-weight-bold mb-1">{item.title}</h6>
                                    <p class="small text-muted mb-2">{item.desc}</p>
                                    {item.url && (
                                        <a href={item.url} target="_blank" class="btn btn-link btn-sm p-0 text-primary">Read More</a>
                                    )}
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
            </div>
          )}
          
          <!-- Call to Action / Engagement -->
          <div class="card mt-5 border-left-primary shadow-sm bg-light">
            <div class="card-body">
                <h4 class="card-title text-primary"><i class="fas fa-users mr-2"></i>Help Improve this Curriculum</h4>
                <p class="card-text">
                    This lesson is currently in the <strong>{lesson.status}</strong> phase. 
                    {currentStatus === 'beta' ? (
                        <span>We are actively seeking instructors to <strong>pilot this lesson</strong> in their own institutions. Feedback from external teaching is critical for reaching "Stable" status.</span>
                    ) : currentStatus === 'alpha' ? (
                        <span>The authors are currently piloting this draft. You can help by reviewing the materials and reporting any bugs or areas for improvement.</span>
                    ) : (
                        <span>This curriculum is in its early stages. Keep an eye on this space for future updates.</span>
                    )}
                </p>
                <div class="mt-3">
                    <a 
                        href={`https://github.com/ucla-imls-open-sci/ucla-imls-open-sci.github.io/issues/new?template=pilot-interest.yml&title=Pilot Interest: ${encodeURIComponent(lesson.name)}`} 
                        target="_blank" 
                        class="btn btn-success btn-sm mb-2 mr-2"
                    >
                        <i class="fas fa-hand-paper mr-1"></i> Express Interest in Piloting
                    </a>
                    {lesson.repo && (
                        <a href={`${lesson.repo}/issues`} target="_blank" class="btn btn-outline-dark mr-2 btn-sm mb-2">
                            <i class="fab fa-github mr-1"></i> Report an Issue
                        </a>
                    )}
                    {lesson.url && (
                        <a href={lesson.url} target="_blank" class="btn btn-outline-primary btn-sm mb-2">
                            <i class="fas fa-chalkboard-teacher mr-1"></i> Teach This Lesson
                        </a>
                    )}
                </div>
                <hr />
                <p class="small text-muted mb-0">
                    <i class="fas fa-info-circle mr-1"></i> 
                    For more on how to run a pilot, visit 
                    <a href="https://docs.carpentries.org/resources/curriculum/lesson-pilots.html" target="_blank" class="text-muted text-decoration-underline">The Carpentries Handbook</a>.
                </p>
            </div>
          </div>

        </div>

        <!-- Sidebar: Authors & Resources -->
        <div class="col-lg-4">
          
          <!-- Why Teach This? (Conditional) -->
          {lesson.why_teach && (
            <div class="card border-0 shadow-sm mb-4 bg-primary text-white">
                <div class="card-body">
                    <h5 class="card-title"><i class="fas fa-lightbulb mr-2"></i>Why Teach This?</h5>
                    <p class="card-text small">{lesson.why_teach}</p>
                </div>
            </div>
          )}

          <!-- Instructor Specs -->
          <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white font-weight-bold">Instructor Specs</div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    <li class="mb-2">
                        <i class="fas fa-clock mr-2 text-muted" style="width: 20px;"></i>
                        <strong>Duration:</strong> {lesson.duration || "90m - 3h (estimated)"}
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-layer-group mr-2 text-muted" style="width: 20px;"></i>
                        <strong>Level:</strong> {lesson.educationalLevel}
                    </li>
                    {lesson.prerequisites && lesson.prerequisites.length > 0 && (
                        <li class="mb-2">
                            <i class="fas fa-clipboard-list mr-2 text-muted" style="width: 20px;"></i>
                            <strong>Prerequisites:</strong>
                            <ul class="pl-4 mt-1 mb-0" style="font-size: 0.9rem;">
                                {lesson.prerequisites.map((req: any) => (
                                    <li>
                                        {req.url ? (
                                            <a href={req.url} target="_blank" class="text-primary">{req.name}</a>
                                        ) : (
                                            req.name
                                        )}
                                    </li>
                                ))}
                            </ul>
                        </li>
                    )}
                    <li class="mb-2">
                        <i class="fas fa-balance-scale mr-2 text-muted" style="width: 20px;"></i>
                        <strong>License:</strong> CC-BY 4.0
                    </li>
                </ul>
            </div>
          </div>

          <!-- Citation Card -->
          {!isExternal && (
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-light font-weight-bold">Cite this Lesson</div>
                <div class="card-body">
                    <p class="small text-muted mb-2">APA Format:</p>
                    <div class="bg-light p-2 rounded mb-3 border text-break small">
                        {citation.apa}
                    </div>
                    <button class="btn btn-outline-primary btn-sm btn-block copy-btn" data-copy={citation.apa}>
                        <i class="far fa-copy mr-1"></i> Copy Citation
                    </button>
                    
                    <hr class="my-3" />
                    
                    <p class="small text-muted mb-2">BibTeX:</p>
                    <details>
                        <summary class="small text-primary cursor-pointer mb-2">Show BibTeX</summary>
                        <pre class="bg-light p-2 rounded border small text-break mb-2" style="font-size: 0.75rem;"><code>{citation.bibtex}</code></pre>
                        <button class="btn btn-outline-dark btn-sm btn-block copy-btn" data-copy={citation.bibtex}>
                            <i class="far fa-copy mr-1"></i> Copy BibTeX
                        </button>
                    </details>
                </div>
            </div>
          )}

          <!-- Resources Card -->
          <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white font-weight-bold">Resources</div>
            <div class="list-group list-group-flush">
                {lesson.url && (
                    <a href={lesson.url} target="_blank" class="list-group-item list-group-item-action">
                        <i class={`fas ${isExternal ? 'fa-external-link-alt' : 'fa-laptop'} mr-2 text-primary`}></i> {isExternal ? 'Visit Resource' : 'Lesson Website'}
                    </a>
                )}
                {lesson.repo && (
                    <a href={lesson.repo} target="_blank" class="list-group-item list-group-item-action">
                        <i class="fab fa-github mr-2 text-dark"></i> GitHub Repository
                    </a>
                )}
                {lesson.notes && (
                    <a href={lesson.notes} target="_blank" class="list-group-item list-group-item-action">
                        <i class="fas fa-sticky-note mr-2 text-warning"></i> Instructor Notes
                    </a>
                )}
            </div>
          </div>

          <!-- Authors Card -->
          <div class="card bg-light border-0 shadow-sm">
            <div class="card-body">
              <h4 class="card-title mb-4">Authors</h4>
              {lesson.authors && lesson.authors.map((authorName: string) => {
                  const profile = getAuthorDetails(authorName);
                  const rawImage = profile?.image || '/assets/img/committee/default.jpeg';
                  const image = rawImage.startsWith('/') ? rawImage : `/${rawImage}`;
                  const authorSlug = slugify(authorName);
                  return (
                    <div class="media mb-4 align-items-center">
                        <img 
                            class="mr-3 rounded-circle" 
                            src={image} 
                            alt={authorName} 
                            style="width: 64px; height: 64px; object-fit: cover;"
                        />
                        <div class="media-body">
                            <h5 class="mt-0 mb-0" style="font-size: 1.1rem;">
                                <a href={`/authors/${authorSlug}`} class="text-dark">{authorName}</a>
                            </h5>
                            {profile?.role && <small class="text-muted d-block">{profile.role}</small>}
                            {profile?.orcid && (
                                <a href={`https://orcid.org/${profile.orcid}`} target="_blank" rel="noopener noreferrer" class="text-muted" style="font-size: 0.85rem;" aria-label={`ORCID for ${authorName}`}>
                                    <i class="fab fa-orcid text-success mr-1"></i>
                                </a>
                            )}
                        </div>
                    </div>
                  );
              })}
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</Layout>

<script>
  // Simple copy to clipboard logic
  document.querySelectorAll('.copy-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const text = btn.getAttribute('data-copy');
      if (text) {
        navigator.clipboard.writeText(text).then(() => {
          const originalHTML = btn.innerHTML;
          btn.innerHTML = '<i class="fas fa-check mr-1 text-success"></i> Copied!';
          setTimeout(() => {
            btn.innerHTML = originalHTML;
          }, 2000);
        });
      }
    });
  });
</script>

<style>
/* Simple CSS Tooltip */
.custom-tooltip {
    visibility: hidden;
    width: 280px;
    background-color: #333;
    color: #fff;
    text-align: center;
    border-radius: 6px;
    padding: 10px;
    position: absolute;
    z-index: 1;
    bottom: 125%; /* Position above */
    left: 50%;
    margin-left: -140px;
    opacity: 0;
    transition: opacity 0.3s;
    font-size: 0.9rem;
    font-weight: normal;
    text-shadow: none;
    box-shadow: 0 5px 10px rgba(0,0,0,0.2);
}

.custom-tooltip::after {
    content: "";
    position: absolute;
    top: 100%;
    left: 50%;
    margin-left: -5px;
    border-width: 5px;
    border-style: solid;
    border-color: #333 transparent transparent transparent;
}

.position-relative:hover .custom-tooltip {
    visibility: visible;
    opacity: 1;
}

.border-left-primary {
    border-left: 5px solid #ffd100;
}

.cursor-pointer {
    cursor: pointer;
}
</style>